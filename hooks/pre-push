#!/bin/bash

echo "ğŸ” Running pre-push checks..."

# Analyze code
echo "ğŸ” Analyzing code..."
flutter analyze > analyze_output.txt
if [ $? -ne 0 ]; then
    echo "âŒ Flutter analyze failed:"
    cat analyze_output.txt
    exit 1
fi

# Format check
echo "ğŸ§¼ Checking code formatting..."
FORMAT_OUTPUT=$(dart format --set-exit-if-changed . 2>&1)
EXIT_CODE=$?

if [[ $EXIT_CODE -ne 0 ]]; then
    echo "âŒ Code formatting issues found:"
    echo "$FORMAT_OUTPUT"
    exit 1
fi


# Lint check (if needed separately)
# echo "ğŸ” Running dart lint..."
# dart run lint  # optional if flutter analyze covers it

# Optional: Block print/debugPrint in lib/
echo "ğŸ•µï¸ Checking for debug prints..."
PRINT_USAGE=$(grep -rnw "lib/" -e "print" -e "debugPrint" | grep -v "// allow")
if [[ ! -z "$PRINT_USAGE" ]]; then
    echo "âŒ print/debugPrint found in code:"
    echo "$PRINT_USAGE"
    exit 1
fi

echo "ğŸ§ª Running tests..."
flutter test
if [ $? -ne 0 ]; then
    echo "âŒ Tests failed!"
    exit 1
fi


echo "âœ… All checks passed. Proceeding with push."
exit 0
