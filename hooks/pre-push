#!/bin/bash

echo "🔍 Running pre-push checks..."

# Analyze code
echo "🔍 Analyzing code..."
flutter analyze > analyze_output.txt
if [ $? -ne 0 ]; then
    echo "❌ Flutter analyze failed:"
    cat analyze_output.txt
    exit 1
fi

# Format check
echo "🧼 Checking code formatting..."
FORMAT_OUTPUT=$(dart format --set-exit-if-changed . 2>&1)
EXIT_CODE=$?

if [[ $EXIT_CODE -ne 0 ]]; then
    echo "❌ Code formatting issues found:"
    echo "$FORMAT_OUTPUT"
    exit 1
fi


# Lint check (if needed separately)
# echo "🔎 Running dart lint..."
# dart run lint  # optional if flutter analyze covers it

# Optional: Block print/debugPrint in lib/
echo "🕵️ Checking for debug prints..."
PRINT_USAGE=$(grep -rnw "lib/" -e "print" -e "debugPrint" | grep -v "// allow")
if [[ ! -z "$PRINT_USAGE" ]]; then
    echo "❌ print/debugPrint found in code:"
    echo "$PRINT_USAGE"
    exit 1
fi

echo "🧪 Running tests..."
flutter test
if [ $? -ne 0 ]; then
    echo "❌ Tests failed!"
    exit 1
fi


echo "✅ All checks passed. Proceeding with push."
exit 0
